<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü | ‡¶∂‡¶æ‡¶°‡¶º‡¶ø ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶∞</title>
    <link rel="stylesheet" href="./styles/variables.css">
    <link rel="stylesheet" href="./styles/main.css">
    <link rel="stylesheet" href="./modules/admin/order-view/orders.css">
</head>
<body>
    <div class="orders-container">
        <div class="orders-header">
            <h2>üì¶ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h2>
            <a href="dashboard.html" class="btn-back">‚¨Ö ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</a>
        </div>

        <div class="orders-card">
            <div class="table-responsive">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                            <th>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                            <th>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
                            <th>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü</th>
                            <th>‡¶¶‡¶æ‡¶Æ</th>
                            <th>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</th>
                            <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                            <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <tr>
                            <td colspan="8" class="loading-text">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './config/firebase-config.js';
        import { collection, getDocs, query, orderBy, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        async function loadOrders() {
            const tableBody = document.getElementById('orders-table-body');

            try {
                const q = query(collection(db, "orders"), orderBy("orderDate", "desc"));
                const querySnapshot = await getDocs(q);

                let html = '';
                let count = 0;

                querySnapshot.forEach((doc) => {
                    const order = doc.data();
                    count++;
                    
                    const date = order.orderDate ? new Date(order.orderDate.seconds * 1000).toLocaleDateString('bn-BD') : 'N/A';

                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${order.customerName}</td>
                            <td><a href="tel:${order.phone}">${order.phone}</a></td>
                            <td>${order.productName}</td>
                            <td>‡ß≥ ${order.price}</td>
                            <td>${order.address}</td>
                            <td>
                                <span class="badge badge-${order.status}" onclick="toggleStatus('${doc.id}', '${order.status}')" style="cursor:pointer">
                                    ${order.status === 'pending' ? '‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®' : '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®'}
                                </span>
                            </td>
                            <td>
                                <button class="btn-del" onclick="deleteOrder('${doc.id}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });

                if (count === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶®‡ßá‡¶á‡•§</td></tr>';
                } else {
                    tableBody.innerHTML = html;
                }

            } catch (error) {
                console.error("Error loading orders:", error);
                tableBody.innerHTML = '<tr><td colspan="8" style="color:red; text-align:center;">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</td></tr>';
            }
        }

        window.deleteOrder = async (id) => {
            if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                try {
                    await deleteDoc(doc(db, "orders", id));
                    loadOrders();
                } catch (error) {
                    alert("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!");
                }
            }
        };

        window.toggleStatus = async (id, currentStatus) => {
            const newStatus = currentStatus === 'pending' ? 'completed' : 'pending';
            try {
                await updateDoc(doc(db, "orders", id), { status: newStatus });
                loadOrders();
            } catch (error) {
                console.error(error);
            }
        };

        loadOrders();
    </script>
</body>
</html>