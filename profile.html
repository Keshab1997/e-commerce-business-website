<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Profile | SootBoot</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="modules/common/navbar/navbar.css">
    <link rel="stylesheet" href="modules/common/footer/footer.css">
    
    <style>
        body { background-color: #f4f7f6; }
        
        /* ‡¶´‡ßÅ‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ */
        .profile-wrapper {
            width: 100%;
            padding: 40px 4%;
            margin: 0 auto;
            max-width: 1400px;
        }

        /* ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ */
        .user-profile-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            margin-bottom: 40px;
            border: 1px solid #eee;
        }
        .user-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--secondary-color); object-fit: cover; }
        .user-info h2 { font-size: 1.8rem; color: #333; margin-bottom: 5px; }
        .user-info p { color: #777; }

        .btn-logout-top {
            margin-left: auto; padding: 10px 25px; background: #fff0f0; color: #ff4757;
            border: none; border-radius: 50px; font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        .btn-logout-top:hover { background: #ff4757; color: white; }

        /* ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° */
        .order-card {
            background: white; padding: 30px; border-radius: 20px;
            margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.03);
            border: 1px solid #eee; transition: 0.3s;
        }
        .order-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.08); }

        /* üöö ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡¶Ø‡¶º‡¶æ‡¶Æ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç ‡¶¨‡¶æ‡¶∞ */
        .tracking-box {
            margin: 50px 0 30px;
            position: relative;
            padding: 0 20px;
        }
        .track-line-bg { height: 6px; background: #e0e0e0; width: 100%; position: absolute; top: 10px; left: 0; border-radius: 10px; }
        .track-line-fill { 
            height: 6px; background: #2ecc71; width: 0%; position: absolute; 
            top: 10px; left: 0; border-radius: 10px; transition: width 1.5s ease-in-out; 
        }

        /* ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶≠‡ßç‡¶Ø‡¶æ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® */
        .delivery-van {
            position: absolute;
            top: -25px;
            left: 0%;
            font-size: 2rem;
            transition: left 1.5s ease-in-out;
            z-index: 5;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
            
            /* üëá ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶≠‡ßç‡¶Ø‡¶æ‡¶®‡¶ü‡¶ø‡¶ï‡ßá ‡¶â‡¶≤‡ßç‡¶ü‡ßá ‡¶¶‡ßá‡¶¨‡ßá (Mirror Effect) */
            transform: scaleX(-1); 
        }

        .track-steps { display: flex; justify-content: space-between; position: relative; z-index: 2; }
        .t-step { text-align: center; width: 100px; }
        .t-dot { 
            width: 25px; height: 25px; background: #e0e0e0; border-radius: 50%; 
            margin: 0 auto 10px; border: 4px solid white; box-shadow: 0 0 0 2px #e0e0e0;
            transition: 0.5s;
        }
        .t-step.active .t-dot { background: #2ecc71; box-shadow: 0 0 0 2px #2ecc71; }
        .t-step.active p { color: #2ecc71; font-weight: 800; }
        .t-step p { font-size: 0.9rem; color: #888; margin: 0; }

        /* ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü */
        .order-items-mini { margin-top: 30px; border-top: 1px solid #f0f0f0; padding-top: 20px; }
        .mini-item { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .mini-item img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }

        /* ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ */
        @media (max-width: 768px) {
            .profile-wrapper { padding: 20px 15px 100px; }
            .user-profile-card { flex-direction: column; text-align: center; }
            .btn-logout-top { margin: 10px auto 0; width: 100%; }
            .delivery-van { font-size: 1.5rem; top: -20px; }
        }
    </style>
</head>
<body>

    <nav class="navbar"></nav>

    <div class="profile-wrapper">
        <!-- ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° -->
        <div class="user-profile-card">
            <img id="u-img" src="" class="user-avatar">
            <div class="user-info">
                <h2 id="u-name">Loading...</h2>
                <p id="u-email">...</p>
            </div>
            <button onclick="logout()" class="btn-logout-top">Logout</button>
        </div>

        <h3 style="margin-bottom: 25px; font-size: 1.5rem; color: #333;">üì¶ My Orders</h3>
        
        <div id="order-list">
            <p style="text-align:center; padding:50px; color:#888;">Fetching your orders...</p>
        </div>
    </div>

    <!-- Dynamic Footer -->
    <footer class="site-footer">
        <div class="footer-container">
            <!-- ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶ï‡¶≤‡¶æ‡¶Æ -->
            <div class="footer-col brand-col">
                <img id="f-logo-img" src="" alt="Logo" style="display:none; max-height: 70px; margin-bottom: 15px;">
                <h2 id="f-name" class="footer-logo">Loading...</h2>
                <p id="f-desc" class="footer-desc">...</p>
                <div class="social-icons">
                    <a href="#" id="f-fb" target="_blank" class="social-btn fb"><img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="FB"></a>
                    <a href="#" id="f-insta" target="_blank" class="social-btn insta"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" alt="Insta"></a>
                    <a href="#" id="f-wa" target="_blank" class="social-btn wa"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WA"></a>
                </div>
            </div>

            <!-- ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶≤‡¶æ‡¶Æ -->
            <div class="footer-col">
                <h4>Quick Links</h4>
                <ul class="footer-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="shop.html">Collection</a></li>
                </ul>
            </div>

            <!-- ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶≤‡¶æ‡¶Æ -->
            <div class="footer-col">
                <h4>Contact Us</h4>
                <div class="contact-info">
                    <a href="#" id="f-phone-link" class="footer-contact-link">
                        <span id="f-phone">üìû ...</span>
                    </a>
                    <a href="#" id="f-email-link" class="footer-contact-link">
                        <span id="f-email">‚úâÔ∏è ...</span>
                    </a>
                    <p id="f-address">üìç ...</p>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; <span id="year">2025</span> <span id="f-copyright-name">SootBoot</span> | All Rights Reserved</p>
        </div>
    </footer>

    <script type="module">
        import { loadNavbar } from './modules/common/navbar/navbar.js';
        import { loadShopBranding } from './utils/global-loader.js';
        import { db, auth, logoutUser } from './config/firebase-config.js';
        import { collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import './utils/chat-loader.js';

        loadNavbar();
        loadShopBranding();
        window.logout = logoutUser;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('u-name').innerText = user.displayName;
                document.getElementById('u-email').innerText = user.email;
                document.getElementById('u-img').src = user.photoURL || 'https://via.placeholder.com/100';

                const q = query(collection(db, "orders"), where("userEmail", "==", user.email), orderBy("orderDate", "desc"));
                const snapshot = await getDocs(q);
                const list = document.getElementById('order-list');
                
                if (snapshot.empty) {
                    list.innerHTML = "<div style='text-align:center; padding:50px; background:white; border-radius:20px;'><p>No orders yet. Start shopping!</p></div>";
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const date = new Date(order.orderDate.seconds * 1000).toDateString();
                    
                    // ‡¶™‡ßç‡¶∞‡ßã‡¶ó‡ßç‡¶∞‡ßá‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶≠‡ßç‡¶Ø‡¶æ‡¶® ‡¶™‡¶ú‡¶ø‡¶∂‡¶®
                    let progress = 0;
                    let vanPos = 0;
                    let s1='', s2='', s3='';
                    
                    if (order.status === 'pending') { progress = 5; vanPos = 0; s1 = 'active'; }
                    else if (order.status === 'shipped') { progress = 50; vanPos = 45; s1 = 'active'; s2 = 'active'; }
                    else if (order.status === 'delivered') { progress = 100; vanPos = 92; s1 = 'active'; s2 = 'active'; s3 = 'active'; }

                    let itemsHtml = '';
                    const items = order.items || [];
                    items.forEach(item => {
                        itemsHtml += `
                            <div class="mini-item">
                                <img src="${item.image}">
                                <div>
                                    <h4 style="margin:0; font-size:1rem;">${item.name}</h4>
                                    <p style="margin:0; font-size:0.8rem; color:#777;">‚Çπ ${item.price} | ${item.size || 'N/A'}</p>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                        <div class="order-card">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <h4 style="margin:0; color:var(--primary-color);">Order #${doc.id.slice(0,8).toUpperCase()}</h4>
                                    <p style="font-size:0.85rem; color:#888; margin:5px 0;">Placed on ${date}</p>
                                </div>
                                <div style="text-align:right;">
                                    <span style="font-size:1.2rem; font-weight:800;">‚Çπ ${order.totalPrice}</span>
                                    <p style="font-size:0.8rem; color:green; font-weight:bold; margin:0;">Paid via COD</p>
                                </div>
                            </div>

                            <!-- üöö ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
                            ${order.status !== 'cancelled' ? `
                            <div class="tracking-box">
                                <div class="track-line-bg"></div>
                                <div class="track-line-fill" style="width: ${progress}%"></div>
                                <div class="delivery-van" style="left: ${vanPos}%">üöö</div>
                                
                                <div class="track-steps">
                                    <div class="t-step ${s1}"><div class="t-dot"></div><p>Ordered</p></div>
                                    <div class="t-step ${s2}"><div class="t-dot"></div><p>Shipped</p></div>
                                    <div class="t-step ${s3}"><div class="t-dot"></div><p>Delivered</p></div>
                                </div>
                            </div>
                            ` : `<p style="color:red; font-weight:bold; text-align:center; background:#fff0f0; padding:15px; border-radius:10px; margin-top:20px;">‚ùå This order was cancelled</p>`}

                            <div class="order-items-mini">
                                ${itemsHtml}
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            } else {
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>