<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Cart | SootBoot</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="modules/common/navbar/navbar.css">
    <link rel="stylesheet" href="modules/common/footer/footer.css">
    
    <style>
        body { background-color: #f8f9fa; }
        
        /* ‡¶´‡ßÅ‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ */
        .cart-wrapper {
            width: 100%;
            padding: 40px 4%;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1.5fr 1fr; /* ‡¶¨‡¶æ‡¶Æ‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ, ‡¶°‡¶æ‡¶®‡ßá ‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü */
            gap: 40px;
            min-height: 70vh;
        }

        .cart-section-title {
            font-size: 2rem;
            font-weight: 800;
            color: #333;
            margin-bottom: 30px;
            grid-column: 1 / -1; /* ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶™‡ßÅ‡¶∞‡ßã‡¶ü‡¶æ ‡¶ú‡ßÅ‡¶°‡¶º‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
        }

        /* ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° */
        .cart-items-list { display: flex; flex-direction: column; gap: 20px; }
        
        .cart-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03);
            border: 1px solid #eee;
            transition: 0.3s;
        }
        .cart-item:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        
        .cart-item img { width: 120px; height: 120px; object-fit: cover; border-radius: 10px; }
        
        .item-info { flex: 1; }
        .item-info h4 { font-size: 1.3rem; margin-bottom: 5px; color: #222; }
        .item-info p { color: #777; font-size: 0.95rem; margin-bottom: 5px; }
        .item-price { font-size: 1.4rem; font-weight: 800; color: var(--primary-color); }
        
        .btn-remove {
            background: #fff0f0; color: #ff4757; border: none;
            padding: 10px 15px; border-radius: 8px; cursor: pointer;
            font-weight: 700; transition: 0.3s;
        }
        .btn-remove:hover { background: #ff4757; color: white; }

        /* ‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü ‡¶∏‡ßá‡¶ï‡¶∂‡¶® (‡¶°‡¶æ‡¶® ‡¶™‡¶æ‡¶∂) */
        .checkout-card {
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
            height: fit-content;
            position: sticky;
            top: 100px;
            border-top: 5px solid var(--primary-color);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #555;
        }
        .total-row {
            border-top: 2px dashed #eee;
            margin-top: 20px;
            padding-top: 20px;
            font-size: 1.8rem;
            font-weight: 800;
            color: #000;
        }

        /* ‡¶´‡¶∞‡ßç‡¶Æ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        .form-group { margin-top: 25px; }
        .form-group label { display: block; font-weight: 700; margin-bottom: 10px; color: #333; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 14px; border: 1px solid #e0e0e0;
            border-radius: 10px; font-size: 1rem; background: #fafafa;
            transition: 0.3s;
        }
        .form-group input:focus { border-color: var(--primary-color); background: white; outline: none; }

        .btn-location {
            background: none; border: none; color: #1976d2; font-weight: 700;
            cursor: pointer; font-size: 0.85rem; float: right;
        }

        .btn-confirm {
            width: 100%; padding: 18px; background: var(--primary-color);
            color: white; border: none; border-radius: 50px;
            font-size: 1.2rem; font-weight: 800; cursor: pointer;
            margin-top: 30px; transition: 0.3s;
            box-shadow: 0 10px 20px rgba(128, 0, 0, 0.2);
        }
        .btn-confirm:hover { transform: translateY(-3px); background: #600000; }

        /* ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏‡¶ø‡¶≠ */
        @media (max-width: 992px) {
            .cart-wrapper { grid-template-columns: 1fr; padding: 20px 15px 100px; }
            .checkout-card { position: static; }
            .cart-item img { width: 90px; height: 90px; }
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar"></nav>

    <div class="cart-wrapper">
        <h2 class="cart-section-title">üõí Your Shopping Bag</h2>

        <!-- ‡¶¨‡¶æ‡¶Æ ‡¶™‡¶æ‡¶∂: ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü -->
        <div class="cart-items-list" id="cart-items">
            <p style="text-align:center; padding:50px; color:#888;">Loading your bag...</p>
        </div>

        <!-- ‡¶°‡¶æ‡¶® ‡¶™‡¶æ‡¶∂: ‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø -->
        <div class="checkout-card" id="checkout-section">
            <h3>Order Summary</h3>
            <div class="summary-row" style="margin-top:20px;">
                <span>Subtotal</span>
                <span>‚Çπ <span id="subtotal-price">0</span></span>
            </div>
            <div class="summary-row">
                <span>Delivery</span>
                <span style="color:green; font-weight:bold;">FREE</span>
            </div>
            <div class="summary-row total-row">
                <span>Total</span>
                <span>‚Çπ <span id="total-price">0</span></span>
            </div>

            <form id="checkout-form">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="c-name" placeholder="Enter your name" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="c-phone" placeholder="10-digit mobile number" required>
                </div>
                <div class="form-group">
                    <label>Delivery Address 
                        <button type="button" onclick="getLocation()" class="btn-location">üìç Use Current Location</button>
                    </label>
                    <textarea id="c-address" rows="3" placeholder="House No, Street, Area, PIN..." required></textarea>
                    <p id="loc-status" style="font-size:0.8rem; margin-top:5px;"></p>
                </div>
                <button type="submit" class="btn-confirm">Confirm Order</button>
            </form>
        </div>
    </div>

    <!-- Dynamic Footer -->
    <footer class="site-footer">
        <div class="footer-container">
            <!-- ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶ï‡¶≤‡¶æ‡¶Æ -->
            <div class="footer-col brand-col">
                <img id="f-logo-img" src="" alt="Logo" style="display:none; max-height: 70px; margin-bottom: 15px;">
                <h2 id="f-name" class="footer-logo">Loading...</h2>
                <p id="f-desc" class="footer-desc">...</p>
                <div class="social-icons">
                    <a href="#" id="f-fb" target="_blank" class="social-btn fb"><img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="FB"></a>
                    <a href="#" id="f-insta" target="_blank" class="social-btn insta"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" alt="Insta"></a>
                    <a href="#" id="f-wa" target="_blank" class="social-btn wa"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WA"></a>
                </div>
            </div>

            <!-- ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶≤‡¶æ‡¶Æ -->
            <div class="footer-col">
                <h4>Quick Links</h4>
                <ul class="footer-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="shop.html">Collection</a></li>
                </ul>
            </div>

            <!-- ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶≤‡¶æ‡¶Æ -->
            <div class="footer-col">
                <h4>Contact Us</h4>
                <div class="contact-info">
                    <p id="f-phone">üìû ...</p>
                    <p id="f-email">‚úâÔ∏è ...</p>
                    <p id="f-address">üìç ...</p>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; <span id="year">2025</span> <span id="f-copyright-name">SootBoot</span> | All Rights Reserved</p>
        </div>
    </footer>

    <script type="module">
        import { loadNavbar } from './modules/common/navbar/navbar.js';
        import { loadShopBranding } from './utils/global-loader.js';
        import { getCart, clearCart, updateCartCount } from './utils/cart.js';
        import { db, auth } from './config/firebase-config.js';
        import { collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        loadNavbar();
        loadShopBranding();

        function renderCart() {
            const cart = getCart();
            const container = document.getElementById('cart-items');
            const checkoutCard = document.getElementById('checkout-section');
            let total = 0;
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:50px; background:white; border-radius:20px;">
                        <p style="font-size:1.5rem; color:#888;">Your bag is empty!</p>
                        <a href="shop.html" class="btn-confirm" style="display:inline-block; width:auto; margin-top:20px; text-decoration:none;">Start Shopping</a>
                    </div>
                `;
                checkoutCard.style.display = 'none';
                return;
            }

            container.innerHTML = '';
            cart.forEach((item, index) => {
                total += Number(item.price);
                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.image}" alt="${item.name}">
                        <div class="item-info">
                            <h4>${item.name}</h4>
                            <p>Color: ${item.color} | Size: ${item.size}</p>
                            <div class="item-price">‚Çπ ${item.price}</div>
                        </div>
                        <button class="btn-remove" onclick="removeItem(${index})">Remove</button>
                    </div>
                `;
            });
            document.getElementById('subtotal-price').innerText = total;
            document.getElementById('total-price').innerText = total;
        }

        window.removeItem = (index) => {
            let cart = getCart();
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            renderCart();
        };

        window.getLocation = () => {
            const status = document.getElementById('loc-status');
            const addressBox = document.getElementById('c-address');
            if (!navigator.geolocation) { 
                status.innerText = "Location not supported"; 
                status.style.color = "red";
                return; 
            }
            status.innerText = "Locating...";
            status.style.color = "blue";
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                    const data = await res.json();
                    addressBox.value = data.display_name;
                    status.innerText = "‚úÖ Location Found!";
                    status.style.color = "green";
                } catch (e) { 
                    status.innerText = "Error finding address";
                    status.style.color = "red";
                }
            }, () => { 
                status.innerText = "Permission denied";
                status.style.color = "red";
            });
        };

        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) { 
                alert("Please login to place order!"); 
                return; 
            }

            const cart = getCart();
            if (cart.length === 0) { 
                alert("Cart is empty!"); 
                return; 
            }

            const btn = document.querySelector('.btn-confirm');
            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "orders"), {
                    customerName: document.getElementById('c-name').value,
                    phone: document.getElementById('c-phone').value,
                    address: document.getElementById('c-address').value,
                    userEmail: user.email,
                    items: cart,
                    totalPrice: document.getElementById('total-price').innerText,
                    status: 'pending',
                    orderDate: new Date()
                });
                alert("‚úÖ Order Placed Successfully!");
                clearCart();
                window.location.href = 'profile.html';
            } catch (err) { 
                alert("Error placing order!"); 
                btn.innerText = "Confirm Order"; 
                btn.disabled = false; 
            }
        });

        renderCart();
    </script>
</body>
</html>