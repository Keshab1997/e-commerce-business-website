<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü</title>
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="modules/common/navbar/navbar.css">
    <style>
        .cart-container { max-width: 800px; margin: 50px auto; padding: 20px; }
        .cart-item { display: flex; gap: 15px; background: white; padding: 15px; margin-bottom: 15px; border-radius: 10px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .cart-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; }
        .total-box { text-align: right; font-size: 1.5rem; font-weight: bold; margin-top: 20px; }
        .btn-remove { color: red; cursor: pointer; background: none; border: none; }
        .checkout-form { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #f9f9f9; }
        .btn-location { background: none; border: none; color: #1976d2; font-size: 0.9rem; font-weight: bold; cursor: pointer; padding: 5px 10px; border-radius: 5px; transition: 0.2s; }
        .btn-location:hover { background: #e3f2fd; }
        .btn-block { width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 10px; }
        
        /* ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏‡¶ø‡¶≠ */
        @media (max-width: 768px) {
            body {
                margin: 0;
                padding: 0;
                width: 100%;
                overflow-x: hidden;
            }
            
            .cart-container {
                margin: 10px auto 80px;
                padding: 15px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }

            .cart-item {
                flex-direction: row;
                align-items: flex-start;
                padding: 10px;
            }

            .cart-item img {
                width: 70px;
                height: 70px;
            }

            .btn-remove {
                padding: 5px 10px;
                font-size: 0.8rem;
            }

            .checkout-form {
                padding: 20px;
                margin-top: 20px;
                border-radius: 10px;
            }

            .form-group input, .form-group textarea {
                width: 100%;
                box-sizing: border-box;
                font-size: 16px;
            }

            .btn-block {
                width: 100%;
                font-size: 1rem;
                padding: 15px;
                box-sizing: border-box;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar"></nav>

    <div class="cart-container">
        <h2>üõí ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∂‡¶™‡¶ø‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ó</h2>
        <div id="cart-items"></div>
        
        <div class="total-box">
            ‡¶Æ‡ßã‡¶ü: ‚Çπ <span id="total-price">0</span>
        </div>

        <div class="checkout-form">
            <h3>‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶§‡¶•‡ßç‡¶Ø</h3>
            <form id="checkout-form">
                <div class="form-group">
                    <label>‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="c-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ" required>
                </div>
                <div class="form-group">
                    <label>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
                    <input type="tel" id="c-phone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" required>
                </div>
                <div class="form-group">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <label>‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label>
                        <button type="button" onclick="getLocation()" class="btn-location">
                            üìç ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶®‡¶ø‡¶®
                        </button>
                    </div>
                    <textarea id="c-address" rows="3" placeholder="‡¶¨‡¶æ‡¶∏‡¶æ‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ..." required></textarea>
                    <p id="loc-status" style="font-size:0.8rem; color:green; margin-top:5px;"></p>
                </div>
                <button type="submit" class="btn btn-primary btn-block">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { getCart, clearCart, updateCartCount } from './utils/cart.js';
        import { db, auth, loginWithGoogle } from './config/firebase-config.js';
        import { collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { loadShopBranding } from './utils/global-loader.js';
        import { loadNavbar } from './modules/common/navbar/navbar.js';

        loadNavbar();
        loadShopBranding();

        // ‡¶≤‡¶ó‡¶á‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
        window.googleLogin = async () => {
            try { await loginWithGoogle(); } catch (e) { console.log(e); }
        };

        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï
        onAuthStateChanged(auth, (user) => {
            const menu = document.getElementById('auth-menu');
            if (user) {
                menu.innerHTML = `<a href="profile.html" class="nav-link">üë§ Profile</a>`;
                if(user.email === "keshabsarkar2018@gmail.com") {
                    menu.innerHTML += ` <a href="dashboard.html" class="nav-link" style="color:gold;">üîí Dashboard</a>`;
                }
            } else {
                menu.innerHTML = `<button onclick="googleLogin()" class="btn-login">üîë Login</button>`;
            }
        });

        // ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        window.getLocation = () => {
            const status = document.getElementById('loc-status');
            const addressBox = document.getElementById('c-address');

            if (!navigator.geolocation) {
                status.innerText = "‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§";
                status.style.color = "red";
                return;
            }

            status.innerText = "‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            status.style.color = "blue";

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                    const data = await response.json();
                    
                    if (data && data.display_name) {
                        addressBox.value = data.display_name;
                        status.innerText = "‚úÖ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá!";
                        status.style.color = "green";
                    } else {
                        throw new Error("Address not found");
                    }
                } catch (error) {
                    status.innerText = "‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";
                    status.style.color = "red";
                }
            }, () => {
                status.innerText = "‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¶‡¶ø‡¶®‡•§";
                status.style.color = "red";
            });
        };

        function loadCart() {
            const cart = getCart();
            const container = document.getElementById('cart-items');
            let total = 0;
            
            container.innerHTML = '';
            if (cart.length === 0) {
                container.innerHTML = '<p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø‡•§ <a href="shop.html">‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</a></p>';
                return;
            }

            cart.forEach((item, index) => {
                total += parseInt(item.price);
                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.image}">
                        <div style="flex:1;">
                            <h4>${item.name}</h4>
                            <p>‚Çπ ${item.price} | ${item.size}</p>
                        </div>
                        <button class="btn-remove" onclick="removeItem(${index})">‚ùå</button>
                    </div>
                `;
            });
            document.getElementById('total-price').innerText = total;
        }

        window.removeItem = (index) => {
            let cart = getCart();
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            loadCart();
        };

        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) { 
                alert("‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!"); 
                return; 
            }

            const cart = getCart();
            if (cart.length === 0) { 
                alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!"); 
                return; 
            }

            const btn = e.target.querySelector('button');
            btn.innerText = "‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "orders"), {
                    customerName: document.getElementById('c-name').value,
                    phone: document.getElementById('c-phone').value,
                    address: document.getElementById('c-address').value,
                    userEmail: user.email, // ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø
                    items: cart, // ‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü
                    totalPrice: document.getElementById('total-price').innerText,
                    status: 'pending',
                    orderDate: new Date()
                });
                alert("‚úÖ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§");
                clearCart();
                window.location.href = 'profile.html';
            } catch (err) { 
                alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!"); 
            } finally {
                btn.innerText = "‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®";
                btn.disabled = false;
            }
        });

        loadCart();
    </script>
</body>
</html>